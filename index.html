<html>
   <head>
      <title>OneMap: Crime Spot Demo</title>
      <link rel="stylesheet" href="https://www.onemap.gov.sg/web-assets/libs/leaflet/leaflet.css" />
      <script src="https://www.onemap.gov.sg/web-assets/libs/leaflet/onemap-leaflet.js"></script>
      <style>
         body { font-family: Arial, sans-serif; margin: 0; }
         #mapdiv { height: 90vh; }
         #search-box {
            padding: 10px;
            background: #f9f9f9;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
         }
         input, button {
            padding: 6px 10px;
            font-size: 14px;
            margin-right: 5px;
         }
      </style>
   </head>

   <body>
      <div id="search-box">
         <input type="text" id="address" placeholder="Enter Singapore address (e.g. 123 Ang Mo Kio Ave 3)" size="50" />
         <button onclick="geocodeAddress()">Search & Mark</button>
      </div>

      <div id="mapdiv"></div>

      <script>
         // Map setup
         let sw = L.latLng(1.144, 103.535);
         let ne = L.latLng(1.494, 104.502);
         let bounds = L.latLngBounds(sw, ne);

         let map = L.map('mapdiv', {
            center: L.latLng(1.2868108, 103.8545349),
            zoom: 16
            
         });

         map.setMaxBounds(bounds); 
         
         let basemap = L.tileLayer('https://www.onemap.gov.sg/maps/tiles/Default/{z}/{x}/{y}.png', {
            detectRetina: true,
            maxZoom: 19,
            minZoom: 11,
            attribution: '<img src="https://www.onemap.gov.sg/web-assets/images/logo/om_logo.png" style="height:20px;width:20px;"/>&nbsp;<a href="https://www.onemap.gov.sg/" target="_blank" rel="noopener noreferrer">OneMap</a>&nbsp;&copy;&nbsp;contributors&nbsp;&#124;&nbsp;<a href="https://www.sla.gov.sg/" target="_blank" rel="noopener noreferrer">Singapore Land Authority</a>'
         });

         basemap.addTo(map);

         let currentMarker = null;

         // Function to geocode address and add marker
         async function geocodeAddress() {
            const address = document.getElementById('address').value.trim();
            if (!address) {
               alert("Please enter an address.");
               return;
            }

            const url = `https://developers.onemap.sg/commonapi/search?searchVal=${encodeURIComponent(address)}&returnGeom=Y&getAddrDetails=Y`;

            try {
               const response = await fetch(url);
               const data = await response.json();

               if (data.found > 0) {
                  const result = data.results[0];
                  const lat = parseFloat(result.LATITUDE);
                  const lng = parseFloat(result.LONGITUDE);

                  if (currentMarker) {
                     map.removeLayer(currentMarker);
                  }

                  currentMarker = L.marker([lat, lng]).addTo(map)
                     .bindPopup(`<strong>Reported Location</strong><br>${address}`)
                     .openPopup();

                  map.setView([lat, lng], 17);
               } else {
                  alert("Address not found in OneMap.");
               }
            } catch (error) {
               console.error("Geocoding failed:", error);
               alert("Failed to geocode the address.");
            }
         }
      </script>
   </body>
</html>
